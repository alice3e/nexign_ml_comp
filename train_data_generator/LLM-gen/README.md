# LLM Генератор BPMN Диаграмм

Генератор комплексных BPMN диаграмм на основе LLM (Large Language Models) через Eliza API.

## Описание

Этот модуль использует внешние LLM для генерации осмысленных BPMN 2.0 диаграмм, отражающих реальные бизнес-процессы. В отличие от базового генератора (`../basic`), который создает простые паттерны, LLM генератор создает сложные диаграммы с:

- Множественными пулами и лейнами
- Подпроцессами и вложенностью
- Граничными событиями (Boundary Events)
- Потоками сообщений (Message Flow)
- Промежуточными событиями (Timer, Message)
- Реалистичными бизнес-сценариями

## Структура проекта

```
LLM-gen/
├── config.yaml              # Конфигурация генератора
├── system_prompt.md         # Системный промпт для LLM
├── main.py                  # Главный скрипт
├── requirements.txt         # Зависимости Python
├── core/                    # Основные модули
│   ├── __init__.py
│   ├── eliza_client.py     # Клиент для Eliza API
│   └── response_parser.py  # Парсер ответов модели
├── prompts/                 # Директория с промптами
│   ├── prompt_001_online_shopping.md
│   ├── prompt_002_loan_approval.md
│   ├── prompt_003_employee_onboarding.md
│   ├── prompt_004_incident_management.md
│   └── prompt_005_order_fulfillment.md
├── docs/                    # Документация
│   ├── eliza-api.md        # Документация Eliza API
│   └── example.py          # Примеры использования API
└── output/                  # Выходные файлы (создается автоматически)
    ├── bpmn/               # BPMN XML файлы
    ├── descriptions/       # Текстовые описания (Markdown)
    ├── metadata/           # Метаданные генерации
    └── raw_responses/      # Сырые ответы от модели
```

## Установка

1. Установите зависимости:

```bash
cd LLM-gen
pip install -r requirements.txt
```

2. Настройте переменную окружения с токеном Eliza API:

```bash
export ELIZA_TOKEN=your_token_here
```

## Конфигурация

Отредактируйте `config.yaml` для настройки параметров генерации:

```yaml
# Модель для использования
api:
  model: "deepseek-v3.1-terminus"  # или "alice-ai-235b"
  temperature: 0.7
  max_tokens: 8192
  timeout: 300

# Режим генерации
generation:
  sequential_mode: true  # Последовательная обработка (1 запрос за раз)
  language: "ru"
```

## Использование

### Генерация всех диаграмм

Обработать все промпты из директории `prompts/`:

```bash
python main.py
```

### Генерация одной диаграммы

Обработать конкретный промпт:

```bash
python main.py --prompt prompts/prompt_001_online_shopping.md
```

### Использование другого конфига

```bash
python main.py --config my_config.yaml
```

## Создание промптов

Промпты должны быть в формате Markdown и содержать:

1. **Название процесса** - краткое описание
2. **Участники** - список ролей/пулов
3. **Описание процесса** - пошаговое описание бизнес-логики
4. **Требования** - специфические требования к диаграмме (пулы, гейтвеи, события)

Пример структуры промпта:

```markdown
# Процесс [название]

Создай BPMN диаграмму процесса [описание].

## Основные участники:
- Участник 1
- Участник 2

## Описание процесса:
1. Шаг 1
2. Шаг 2
...

## Требования:
- Используй 2-3 пула
- Добавь XOR Gateway для ветвления
- Используй Timer Event для таймаутов
```

## Выходные файлы

Для каждого промпта генерируются следующие файлы:

1. **`{sample_id}.bpmn`** - BPMN 2.0 XML диаграмма
2. **`{sample_id}.md`** - Текстовое описание процесса в Markdown
3. **`{sample_id}_meta.json`** - Метаданные генерации
4. **`{sample_id}_raw.txt`** - Сырой ответ от модели

Дополнительно создается:
- **`generation_summary.json`** - Сводный отчет о генерации

## Формат выходных файлов

### BPMN XML
Валидный BPMN 2.0 XML с:
- Правильными namespace
- Уникальными ID элементов
- Визуальной информацией (BPMNDiagram)
- Координатами элементов

### Описание (Markdown)
Структурированное описание процесса:
- Общая информация (домен, участники, цель)
- Описание основного потока
- Ветвления и условия
- Особенности (подпроцессы, события, взаимодействия)

### Метаданные (JSON)
```json
{
  "sample_id": "llm_001",
  "prompt_file": "prompts/prompt_001_online_shopping.md",
  "model": "deepseek-v3.1-terminus",
  "temperature": 0.7,
  "max_tokens": 8192,
  "bpmn_file": "output/bpmn/llm_001.bpmn",
  "description_file": "output/descriptions/llm_001.md",
  "status": "success"
}
```

## Валидация и исправление

Генератор автоматически:
- Проверяет валидность XML
- Проверяет соответствие BPMN 2.0 стандарту
- Исправляет распространенные ошибки (если `auto_fix: true`)
- Добавляет XML декларацию если отсутствует
- Исправляет HTML entities

## Доступные модели

### DeepSeek V3.1-Terminus (по умолчанию)
- Модель: `deepseek-v3.1-terminus`
- Хорошо справляется со сложными структурами
- Рекомендуется для большинства задач

### Alice AI 235B
- Модель: `alice-ai-235b`
- Внутренняя модель Яндекса
- Альтернатива для экспериментов

## Логирование

Логи сохраняются в файл `llm_generator.log` и выводятся в консоль.

Уровни логирования (настраивается в `config.yaml`):
- `DEBUG` - детальная информация
- `INFO` - основные события (по умолчанию)
- `WARNING` - предупреждения
- `ERROR` - ошибки

## Интеграция с transformer

Сгенерированные BPMN XML файлы можно передать в модуль `../transformer` для:
- Рендеринга в PNG изображения
- Применения стилизации
- Добавления аугментаций

```bash
# Пример использования с transformer
cd ../transformer
python main.py --input ../LLM-gen/output/bpmn/llm_001.bpmn
```

## Примеры промптов

В директории `prompts/` находятся 5 примеров промптов:

1. **prompt_001_online_shopping.md** - Покупка в интернет-магазине
2. **prompt_002_loan_approval.md** - Одобрение кредита в банке
3. **prompt_003_employee_onboarding.md** - Адаптация нового сотрудника
4. **prompt_004_incident_management.md** - Управление IT-инцидентами
5. **prompt_005_order_fulfillment.md** - Обработка заказа на складе

## Troubleshooting

### Ошибка: ELIZA_TOKEN не установлен
```bash
export ELIZA_TOKEN=your_token_here
```

### Ошибка: SSL Certificate verification failed
Проверьте сертификаты или используйте `verify=False` в коде (уже настроено).

### Модель не отвечает / таймаут
Увеличьте `timeout` в `config.yaml` или проверьте доступность API.

### XML не валиден
Включите `auto_fix: true` в секции `validation` конфига.

## Лицензия

Часть проекта train_data_generator для генерации датасета BPMN диаграмм.