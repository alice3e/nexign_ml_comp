# Миграция на новый рендерер (bpmn-js)

## Что изменилось

### Старая версия (PIL-based)
- ❌ Ручное рисование элементов через PIL/Pillow
- ❌ Возможные искажения и артефакты
- ❌ Неточное соответствие BPMN 2.0 стандарту
- ❌ Проблемы с отображением сложных элементов

### Новая версия (bpmn-js)
- ✅ Использование официальной библиотеки bpmn-js
- ✅ Высококачественный рендеринг без искажений
- ✅ Полное соответствие BPMN 2.0 стандарту
- ✅ Поддержка всех элементов BPMN (включая SubProcess, Pools, Lanes)
- ✅ Правильная типографика и расположение текста

## Требования для миграции

1. **Node.js >= 18.0.0** - для запуска bpmn-js
2. **npm** - для установки зависимостей
3. **Puppeteer зависимости** - системные библиотеки для headless браузера

## Шаги миграции

### 1. Установите Node.js

См. подробные инструкции в [`INSTALL.md`](INSTALL.md)

**Быстрая установка:**

```bash
# macOS
brew install node

# Linux (Ubuntu/Debian)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Windows
# Скачайте с https://nodejs.org/
```

### 2. Установите Node.js зависимости

```bash
cd transformer/renderer
npm install
```

### 3. Обновите код (уже сделано)

Изменения в коде:
- `transformer/main.py` - использует `BPMNRendererJS` вместо `BPMNRenderer`
- `transformer/core/__init__.py` - экспортирует новый рендерер
- `transformer/core/bpmn_renderer_js.py` - новый рендерер на основе bpmn-js

### 4. Запустите трансформер

```bash
cd transformer
python main.py
```

При первом запуске:
- Автоматически проверится наличие Node.js
- Автоматически установятся зависимости (если не установлены)
- Puppeteer скачает Chromium (~150 MB)

## Обратная совместимость

Старый рендерер (`BPMNRenderer`) сохранен в `core/bpmn_renderer.py` для обратной совместимости.

Чтобы вернуться к старому рендереру:

```python
# В transformer/main.py
from core import BPMNRenderer  # вместо BPMNRendererJS

# ...
renderer = BPMNRenderer(style)  # вместо BPMNRendererJS
```

**Не рекомендуется** - старый рендерер имеет проблемы с качеством.

## Производительность

### Старый рендерер (PIL)
- Скорость: ~0.5-2 сек на диаграмму
- Качество: Среднее
- Проблемы: Искажения, неточности

### Новый рендерер (bpmn-js)
- Скорость: ~1-3 сек на диаграмму (первый запуск ~5-10 сек)
- Качество: Высокое
- Проблемы: Требует Node.js

**Вывод:** Небольшое снижение скорости компенсируется значительным улучшением качества.

## Устранение проблем

### "Node.js не найден"

```bash
# Проверьте установку
node --version

# Если не установлен, установите Node.js
# См. INSTALL.md
```

### "npm не найден"

npm устанавливается вместе с Node.js. Переустановите Node.js.

### Ошибки puppeteer на Linux

```bash
# Установите системные зависимости
sudo apt-get install -y libgbm1 libnss3 libatk-bridge2.0-0
```

### Медленный рендеринг

Первый запуск медленнее из-за запуска браузера. Последующие рендеры быстрее.

Для ускорения батч-обработки можно использовать параллельные процессы.

## Преимущества новой версии

1. **Качество** - профессиональный рендеринг без артефактов
2. **Стандарт** - полное соответствие BPMN 2.0
3. **Расширяемость** - поддержка всех элементов BPMN
4. **Надежность** - использование проверенной библиотеки
5. **Поддержка** - активное сообщество bpmn-js

## Дополнительная настройка

### Изменение разрешения

В `config.yaml`:
```yaml
rendering:
  min_resolution: 1024
  max_resolution: 3096  # можно увеличить
```

### Изменение цветовой схемы

Цвета применяются через `backgroundColor` в опциях рендеринга.
Для более сложной стилизации можно модифицировать HTML в `renderer/bpmn_to_png.js`.

### Отключение аугментаций

В `config.yaml`:
```yaml
augmentation:
  rotation:
    enabled: false
  noise:
    enabled: false
  # и т.д.
```

## Поддержка

При возникновении проблем:
1. Проверьте [`INSTALL.md`](INSTALL.md)
2. Проверьте [`renderer/README.md`](renderer/README.md)
3. Убедитесь, что Node.js >= 18.0.0
4. Проверьте логи ошибок

## Roadmap

Планируемые улучшения:
- [ ] Кэширование браузера для ускорения
- [ ] Параллельная обработка
- [ ] Дополнительные темы оформления
- [ ] Поддержка пользовательских CSS стилей
- [ ] Экспорт в SVG (помимо PNG)